<div class="detalhe-container">
  @if (carregando()) {
    <div class="loading">Carregando...</div>
  } @else if (solicitacao()) {
    <div class="header-actions">
      <button mat-button (click)="voltar()">
        <mat-icon>arrow_back</mat-icon>
        Voltar
      </button>
    </div>

    <mat-card class="solicitacao-detalhes">
      <mat-card-header>
        <mat-card-title>{{ solicitacao()!.titulo }}</mat-card-title>
        <mat-card-subtitle>Protocolo: {{ solicitacao()!.protocolo }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="info-row">
          <mat-chip [highlighted]="true">{{ solicitacao()!.status }}</mat-chip>
          <span class="data">Criado em: {{ solicitacao()!.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
        </div>

        <mat-divider></mat-divider>

        <div class="descricao-section">
          <h3>Descrição</h3>
          <p>{{ solicitacao()!.descricao }}</p>
        </div>

        @if (solicitacao()!.anexos.length > 0) {
          <div class="anexos-section">
            <h3>Anexos</h3>
            @for (anexo of solicitacao()!.anexos; track anexo.id) {
              <div class="anexo-item">
                <mat-icon>attachment</mat-icon>
                <a [href]="anexo.url" target="_blank">{{ anexo.nome }}</a>
              </div>
            }
          </div>
        }
      </mat-card-content>

      <mat-card-actions>
        @if (solicitacao()!.status !== 'RESOLVIDO') {
          <button mat-raised-button color="primary" (click)="marcarComoResolvida()">
            Marcar como Resolvida
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <mat-card class="historico-card">
      <mat-card-header>
        <mat-card-title>Histórico e Comunicações</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        @if (historico().length === 0) {
          <p class="empty-historico">Nenhum evento registrado ainda.</p>
        } @else {
          <div class="timeline">
            @for (evento of historico(); track evento.id) {
              <div class="timeline-item">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <div class="evento-header">
                    <strong>{{ evento.usuarioNome || 'Sistema' }}</strong>
                    <span class="evento-data">{{ evento.timestamp | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <p>{{ evento.descricao }}</p>
                </div>
              </div>
            }
          </div>
        }
      </mat-card-content>
    </mat-card>

    <mat-card class="comentario-card">
      <mat-card-header>
        <mat-card-title>Adicionar Comentário</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="comentarioForm" (ngSubmit)="adicionarComentario()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seu comentário</mat-label>
            <textarea matInput formControlName="comentario" rows="4"></textarea>
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit" [disabled]="!comentarioForm.valid">
            Enviar Comentário
          </button>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
